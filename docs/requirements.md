## `simonw/llm` プラグイン「llm-agentchat」要件文書

### 概要

`llm-agentchat` プラグインは、`simonw/llm` CLIを介して、複数のLLMエージェントがIRC風のチャットルームで協働し、人間がWebブラウザを通じてその対話をリアルタイムでモニタリングおよび介入できる環境を提供するツールです。これにより、エージェントの協調的な問題解決プロセスを視覚化し、管理することが可能になります。

---

### 要件

#### 要件 1

**ユーザーストーリー:** ユーザーとして、LLMエージェントの協働チャットサーバーを起動したいので、複数のエージェントが通信できる基盤を確立できる

##### 受入基準

1.  WHEN `llm agentchat-server <room_name>` コマンドが実行される THEN システムは指定された`room_name`でHTTPおよびWebSocketサーバーを起動する SHALL
2.  WHEN サーバーが起動される THEN システムは指定されたポート (`-p`オプション) またはデフォルトポート (`8000`) でリッスンする SHALL
3.  WHEN サーバーが起動される THEN システムは指定されたホスト (`--host`オプション) またはデフォルトホスト (`127.0.0.1` または `0.0.0.0`) でリッスンする SHALL
4.  WHEN サーバーが起動される THEN システムはチャット履歴を保存するためのSQLiteデータベース (`-s`オプション) を初期化または接続する SHALL
5.  WHEN `--no-browser` オプションが指定されない THEN システムはサーバー起動後、自動的にWeb UIをブラウザで開く SHALL

#### 要件 2

**ユーザーストーリー:** ユーザーとして、エージェントをチャットルームに参加させたいので、エージェントが協働を開始できる

##### 受入基準

1.  WHEN `llm agentchat-client <room_name> <agent_name>` コマンドが実行される THEN システムは指定された`agent_name`のエージェントを初期化する SHALL
2.  WHEN エージェントが初期化される THEN システムは指定されたサーバーURL (`-u`オプション) に接続を試みる SHALL
3.  WHEN サーバーに接続される THEN エージェントは指定された`room_name`のWebSocketに接続し、メッセージの送受信を開始する SHALL
4.  WHEN エージェントがチャットに参加する THEN システムはエージェント定義ファイル (`-a`オプション) からエージェントのペルソナ、モデル、ツール設定をロードする SHALL
5.  WHEN エージェントがメッセージを受信する THEN システムはLLMを使用して応答を生成し、サーバーに送信する SHALL

#### 要件 3

**ユーザーストーリー:** ユーザーとして、エージェントの会話をリアルタイムで監視したいので、協働プロセスを把握できる

##### 受入基準

1.  WHEN Web UIがブラウザで開かれる THEN システムは指定されたチャットルームの過去のメッセージを表示する SHALL
2.  WHEN Web UIがサーバーのWebSocketに接続される THEN システムは新しいメッセージをリアルタイムで受信し、表示に反映する SHALL
3.  WHEN Web UIが表示される THEN システムはチャットルームに参加しているエージェントの名前リストを表示する SHALL

#### 要件 4

**ユーザーストーリー:** ユーザーとして、チャットにメッセージを送信したいので、エージェントと直接対話できる

##### 受入基準

1.  WHEN Web UIにメッセージ入力フォームが表示される THEN システムはユーザーがメッセージを入力できる SHALL
2.  WHEN ユーザーがメッセージを送信する THEN システムはそのメッセージをWebサーバーに送信する SHALL
3.  WHEN メッセージがサーバーに送信される THEN システムはそのメッセージをデータベースに保存し、WebSocketを通じて全ての接続済みクライアント（他のエージェント、Web UI）にブロードキャストする SHALL
4.  WHEN ユーザーが `@AgentName <message>` の形式でメッセージを送信する THEN システムは特定の対象エージェントへのメンションとして処理できる SHALL

#### 要件 5

**ユーザーストーリー:** ユーザーとして、エージェントの振る舞いを柔軟に定義したいので、様々なタスクに対応できる

##### 受入基準

1.  WHEN エージェント定義ファイル (`agents.yml`) が提供される THEN システムは各エージェントの名前、LLMモデル、ペルソナ、ツールを読み込む SHALL
2.  WHEN エージェントがメッセージを受信する THEN システムは定義されたペルソナとモデルに基づいて応答を生成する SHALL
3.  WHEN エージェントがツールを呼び出す必要があると判断する THEN システムは定義されたツール (`llm-code`など) を実行できる SHALL
4.  WHEN `common_settings` が定義される THEN システムは会話履歴の制限や応答遅延などの共通設定を適用する SHALL

#### 要件 6

**ユーザーストーリー:** ユーザーとして、チャット履歴を後から確認したいので、エージェントの協働過程を分析できる

##### 受入基準

1.  WHEN メッセージがチャットルームに投稿される THEN システムはそのメッセージをSQLiteデータベースに永続的に保存する SHALL
2.  WHEN Web UIが起動される THEN システムはデータベースから過去のメッセージを取得し表示する SHALL
3.  WHEN サーバーが再起動される THEN システムは以前のチャット履歴をデータベースからロードし、利用可能にする SHALL

#### 要件 7

**ユーザーストーリー:** 開発者として、`simonw/llm` の既存機能を活用したいので、効率的にエージェント機能を構築できる

##### 受入基準

1.  WHEN エージェントがLLMを呼び出す THEN システムは`llm` CLIが管理するモデル (`llm models`) を利用できる SHALL
2.  WHEN エージェントがAPIキーを必要とする THEN システムは`llm keys set`で設定されたAPIキーを安全に取得できる SHALL
3.  WHEN エージェントがツールを実行する THEN システムは`llm`プラグインとして提供されるツール (`llm-code`など) を呼び出せる SHALL
4.  WHEN エージェントのペルソナを設定する THEN システムは`llm prompt create`で定義されたプロンプトを参照できる SHALL
